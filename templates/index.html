<!DOCTYPE html>
<html>

<head>
    <title>Flask Canvas App</title>
    <style></style>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
    <script src="{{ url_for('static', filename='js/box.js') }}"></script>
    <script src="{{ url_for('static', filename='js/helpers.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div id="sidebar">
        <button id="export-mot"> MOT </button> <br><br>
        <button id="next-image"> Next </button> <br><br>
        <button id="prev-image"> Prev </button> <br><br>
    </div>
    <canvas id="myCanvas" width="{{ bg_width }}" height="{{ bg_height }}"></canvas>

    <script>
        // Load the background image onto the canvas
        var canvas = document.getElementById('myCanvas');
        canvas.tabIndex = 1000; // force canvas to listen to keyboard events
        var ctx = canvas.getContext('2d');
        var img = new Image();
        let mouseX, mouseY;
        let frame = 1;

        let squares = { [frame]: [] };
        fetch("/get_image", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ frame: frame })
        })
            .then(res => res.blob()
                .then(imageBlob => {
                    const imageUrl = URL.createObjectURL(imageBlob);
                    img.src = imageUrl;
                    img.onload = function () {
                        ctx.drawImage(img, 0, 0);
                    };
                })
                .catch(err => console.log(err)))
        .catch(err => console.log(err));


        const exportButton = document.querySelector('#export-mot');
        exportButton.addEventListener('click', () => {
            exportToMOT("mot.txt");
        });

        const nextImageButton = document.querySelector('#next-image');
        nextImageButton.addEventListener('click', () => {
            if (!(++frame in squares)) {
                squares[frame] = [];
            }
            loadImage("next");
        });


        const prevImageButton = document.querySelector('#prev-image');
        prevImageButton.addEventListener('click', () => {
            if (!(--frame in squares)) {
                squares[frame] = [];
            }
            loadImage("prev");
        });

    </script>
    <script src="{{ url_for('static', filename='js/canvas-listeners.js') }}"></script>
</body>